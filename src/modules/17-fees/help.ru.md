# Комиссии и счета (Fee Billing & Invoicing)

Модуль управления договорами на обслуживание, расчёта комиссий, выставления счетов и учёта дебиторской задолженности.

## Основные понятия

### Договоры (Contracts)
Соглашение с клиентом о порядке взимания комиссий:
- **AUM fee** — процент от активов под управлением
- **Fixed fee** — фиксированная сумма за период
- **Performance fee** — комиссия за результат (MVP placeholder)
- **Tiered** — ступенчатые ставки по объёму AUM

### Fee Schedule
Детальное расписание ставок:
- Тип расчёта (AUM / Fixed / Performance)
- Процентная ставка или фиксированная сумма
- Тiers (пороги и ставки)
- Минимальная комиссия
- Периодичность (monthly / quarterly)

### Fee Run
Расчётный пакет комиссий за период:
- Выборка активных договоров
- Расчёт комиссии для каждого контракта
- AUM base value (из Portfolio / Net Worth)
- Статусы: draft → locked → invoiced

### Инвойсы (Invoices)
Счёт на оплату комиссий:
- Генерируется из fee run
- Требует согласования при превышении порога
- Статусы: draft → pending_approval → sent → paid / overdue / void
- PDF документ в Document Vault

### AR (Дебиторская задолженность)
Учёт платежей по выставленным счетам:
- Регистрация платежей
- Привязка к cash movements (Liquidity)
- Автоматический расчёт outstanding
- Aging report

## Workflow

### 1. Создание договора
1. Открыть "Создать договор"
2. Выбрать клиента / household
3. Указать fee schedule
4. Установить периодичность billing (monthly / quarterly)
5. Прикрепить документ договора

### 2. Настройка fee schedule
1. Открыть "Создать schedule"
2. Выбрать тип: AUM / Fixed / Performance
3. Указать ставку или сумму
4. При необходимости настроить tiers
5. Указать минимальную комиссию

### 3. Расчёт комиссий (Fee Run)
1. Нажать "Запустить расчёт"
2. Выбрать период (месяц / квартал)
3. Система выбирает активные контракты
4. Для каждого контракта рассчитывается комиссия:
   - AUM: base value × rate / periods per year
   - Fixed: fixed amount / billing periods
   - Tiers: применяются пороговые ставки
5. Проверить расчёт, заблокировать (Lock)

### 4. Генерация инвойсов
1. Из заблокированного fee run нажать "Сгенерировать счета"
2. Для каждого клиента создаётся инвойс
3. Автоматически создаётся PDF в Document Vault
4. Инвойс получает статус draft

### 5. Согласование и отправка
1. Если сумма превышает порог — требуется approval
2. CFO / Owner/Admin одобряют счёт
3. После approval статус: ready_to_send
4. Нажать "Отправить" — статус sent

### 6. Оплата и AR
1. При получении оплаты — "Отметить оплату"
2. Указать сумму, метод, дату
3. Опционально: привязать cash movement из Liquidity
4. При полной оплате статус: paid
5. При частичной: outstanding обновляется

### 7. Posting в GL
1. После оплаты — "Post to GL"
2. Создаётся journal entry:
   - Dr: Cash/AR
   - Cr: Revenue
3. Отметка glPosted в инвойсе

## Интеграции

### Net Worth / Portfolio
- AUM base value для расчёта комиссий
- sourceRef на актуальную оценку активов

### Document Vault
- PDF договоров
- PDF инвойсов
- Audit trail доступа

### Liquidity
- Привязка платежей к cash movements
- Прогноз поступлений от AR

### Bill Pay
- Если клиент платит через платформу
- Автоматическое создание payment record

### General Ledger
- Posting revenue и AR
- Journal entries

## RBAC

| Роль | Права |
|------|-------|
| Owner/Admin/CFO | Полный CRUD, approvals, GL post |
| Operations | Создание счетов, отметка отправки, запись платежей |
| Relationship Manager | Просмотр счетов, отправка клиенту |
| External Advisor | Просмотр shared счетов |
| Client | Только свои счета через share pages |

## Client-safe View

Клиенты видят:
- Номер счёта, период, сумма
- Высокоуровневая расшифровка
- Download PDF
- БЕЗ: внутренних заметок, GL данных, schedule details

## Отчёты

- **Revenue by Client** — выручка по клиентам
- **Fees by Period** — комиссии по периодам
- **AR Aging** — aging дебиторской задолженности
- **Invoice Register** — реестр счетов

## Дисклеймер

> Расчёты комиссий являются расчетными и требуют проверки бухгалтерией.

Все значения носят информационный характер. Финальные суммы должны быть подтверждены бухгалтерией перед выставлением клиентам.

## Audit

Все действия логируются:
- Создание/изменение договора
- Создание/изменение schedule
- Запуск fee run, lock
- Генерация инвойсов
- Submit/approve инвойса
- Отправка клиенту
- Запись платежа
- Posting в GL
- Void инвойса
- Просмотр клиентом
