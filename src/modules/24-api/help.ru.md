# API и Webhooks

## Зачем API и webhooks в MFO

API и webhooks позволяют интегрировать Wealth OS с внешними системами:
- **BI системы** — выгрузка данных для аналитики
- **Бухгалтерия** — синхронизация счетов и платежей
- **CRM** — обновление данных клиентов
- **Внешние консультанты** — ограниченный доступ к данным

## API ключи

### Режимы ключей
- **Server** — полный доступ, используется backend системами
- **Advisor** — доступ консультанта, ограниченный скоупами
- **Client** — клиентский ключ, только client-safe данные

### Scopes (области доступа)
Каждый ключ имеет набор scopes:
- `moduleKey` — модуль (net-worth, performance, invoices...)
- `actionKey` — действие (view, create, edit, approve, export)
- `scopeType` — область (global, household, entity, portfolio)
- `scopeId` — конкретный ID для ограничения

### Жизненный цикл ключа
1. **Создание** — генерируется секрет (показывается один раз!)
2. **Ротация** — создается новый секрет, старый помечается rotated
3. **Отзыв** — ключ немедленно деактивируется

## Client-Safe ключи

Для ключей режима `client`:
- Только операция `view`
- Scope строго ограничен householdId клиента
- Скрываются:
  - internal notes
  - audit IDs
  - staff-only документы

## Webhooks

### Подписка на события
Webhook подписывается на типы событий:
- `invoice.paid` — счет оплачен
- `approval.approved` — утверждение одобрено
- `document.uploaded` — документ загружен
- `sync.failed` — ошибка синхронизации
- `risk.breach` — нарушение риска

### Доставка и retry
- При событии создается delivery
- Попытки: до 5 с backoff 1, 5, 15, 60, 240 минут
- После 5 неудач — статус Dead Letter

### Безопасность
- URL вебхука маскируется в UI
- Опциональный signing secret для проверки подписи
- Можно ограничить scope события

## Rate Limits

Лимиты защищают API от перегрузки:
- По окнам: 1 минута, 5 минут, 1 час, 1 день
- При превышении — код 429 Too Many Requests
- Счетчики сбрасываются автоматически

## API Explorer

Интерактивная песочница для тестирования:
1. Выберите API ключ
2. Выберите endpoint
3. Задайте параметры
4. Нажмите Run
5. Смотрите результат в JSON

## Типовые сценарии

### Выпустить ключ для BI
1. Создать ключ → режим Server
2. Добавить scopes: net-worth view, performance view
3. Установить срок действия
4. Скопировать секрет (показывается один раз!)

### Настроить webhook на invoice.paid
1. Создать webhook
2. URL: https://your-system.com/webhook
3. Events: invoice.paid
4. Сохранить

### Протестировать доставку
1. Открыть webhook
2. Нажать "Test"
3. Посмотреть delivery в Events

### Ограничить доступ household
1. При создании ключа
2. В scopes указать scopeType: household
3. scopeId: ID домохозяйства

## Аудит

Все операции логируются:
- Создание/ротация/отзыв ключа
- Создание/изменение webhook
- Каждый API вызов
- Каждая доставка webhook

## Дисклеймер

> API и вебхуки в MVP демонстрационные. Для production требуются:
> - Защищенное хранение секретов
> - HTTPS для webhook endpoints
> - Инфраструктура очередей
> - Мониторинг и алертинг
