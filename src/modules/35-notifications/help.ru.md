# Модуль «Центр уведомлений и Эскалации»

## Обзор

Модуль **Центр уведомлений** — это унифицированная система управления уведомлениями для всех событий в Wealth OS. Он обеспечивает централизованный контроль над доставкой уведомлений, правилами маршрутизации, эскалациями и дайджестами.

## Основные функции

### 1. Входящие (Inbox)

**Единый почтовый ящик** для всех уведомлений пользователя:

- Просмотр всех уведомлений в хронологическом порядке
- Фильтрация по категории, приоритету, статусу
- Групповые действия (прочитать все, архивировать)
- AI-сортировка по важности
- Быстрые действия прямо из уведомления

**Категории уведомлений:**
- `task` — задачи и назначения
- `approval` — запросы на одобрение
- `alert` — системные оповещения
- `reminder` — напоминания
- `system` — системные сообщения
- `compliance` — комплаенс-уведомления
- `report` — отчёты
- `message` — сообщения
- `escalation` — эскалации

### 2. Правила маршрутизации

**Гибкая настройка правил** для автоматической маршрутизации уведомлений:

- **Триггеры:** событие, расписание, условие, порог
- **Условия:** фильтрация по полям, ролям, группам
- **Каналы:** inbox, email, SMS, push, Slack, Teams, webhook
- **Приоритеты:** низкий, нормальный, высокий, срочный

**Пример правила:**
```
Если: task.status = "overdue" И task.priority = "high"
Кому: роль "manager"
Каналы: inbox + email + push
Приоритет: urgent
Эскалация: через 60 минут → director
```

### 3. Эскалации

**Автоматическая эскалация** при отсутствии реакции:

- Многоуровневая эскалация (уровни 1, 2, 3...)
- Настраиваемые таймауты для каждого уровня
- SLA-отслеживание с предупреждениями
- Ручная эскалация по требованию
- Делегирование на время отсутствия

**Причины эскалации:**
- `no_response` — нет ответа в установленный срок
- `sla_breach` — нарушение SLA
- `manual` — ручная эскалация
- `threshold` — превышение порога
- `critical` — критическое событие

### 4. Дайджесты

**Агрегация уведомлений** в периодические сводки:

- **Частота:** ежечасно, ежедневно, еженедельно
- **Содержание:** сводка по категориям и приоритетам
- **AI-highlights:** выделение важных пунктов
- **Настраиваемое время отправки**

### 5. Шаблоны

**Централизованное управление шаблонами:**

- Поддержка переменных `{{variable}}`
- Разные шаблоны для разных каналов
- Мультиязычность (ru, en, uk)
- Версионирование шаблонов
- Предпросмотр перед сохранением

**Поддерживаемые каналы шаблонов:**
- Текстовый (inbox, SMS)
- HTML (email)
- Slack Block Kit
- Teams Adaptive Cards
- Webhook JSON

### 6. Каналы доставки

**Конфигурация каналов:**

| Канал | Описание | Настройки |
|-------|----------|-----------|
| inbox | Внутренний почтовый ящик | — |
| email | Электронная почта | SMTP, From, Reply-To |
| sms | SMS-сообщения | Провайдер, номер отправителя |
| push | Push-уведомления | VAPID ключи |
| slack | Slack | Webhook URL, Bot Token |
| teams | Microsoft Teams | Webhook URL, Tenant ID |
| webhook | HTTP Webhook | URL, Headers, Auth |

### 7. Персональные настройки

**Пользовательские предпочтения:**

- Включение/отключение по категориям
- Выбор каналов для каждой категории
- Тихие часы (quiet hours)
- Предпочтительный язык
- Настройки дайджеста
- Делегат на время отсутствия

## Интеграция с другими модулями

Модуль уведомлений интегрируется со всеми модулями системы:

- **Задачи** — уведомления о назначении, дедлайнах, завершении
- **Документы** — уведомления о новых версиях, запросах подписи
- **Согласия** — уведомления о новых запросах доступа
- **Комплаенс** — уведомления о нарушениях и проверках
- **Отчёты** — уведомления о готовности отчётов

## AI-функции

### AI-триаж

Автоматическая оценка важности уведомлений:

- **AI Score (0-100)** — оценка важности
- **AI Tags** — автоматические метки
- **Smart Sorting** — сортировка по важности
- **Anomaly Detection** — выявление аномалий

### AI-рекомендации

- Предложения по настройке правил
- Выявление паттернов игнорирования
- Рекомендации по эскалации

## Разграничение доступа (RBAC)

| Роль | Права |
|------|-------|
| user | Просмотр своих уведомлений, настройка предпочтений |
| manager | + Просмотр уведомлений команды, управление эскалациями |
| admin | + Управление правилами, шаблонами, каналами |
| superadmin | + Полный доступ, системные настройки |

## API

### Endpoints

```
GET    /api/collections/notifications          — список уведомлений
GET    /api/collections/notifications/:id      — детали уведомления
PATCH  /api/collections/notifications/:id      — обновление (прочитано, отложено)

GET    /api/collections/notificationRules      — список правил
POST   /api/collections/notificationRules      — создание правила
PATCH  /api/collections/notificationRules/:id  — обновление правила

GET    /api/collections/escalations            — список эскалаций
PATCH  /api/collections/escalations/:id        — подтверждение/разрешение

GET    /api/collections/digests                — список дайджестов
GET    /api/collections/notificationTemplates  — список шаблонов
GET    /api/collections/notificationChannels   — список каналов
GET    /api/collections/userNotificationPrefs  — настройки пользователя
PATCH  /api/collections/userNotificationPrefs/:id — обновление настроек
```

## Метрики и KPI

- **Непрочитано** — количество непрочитанных уведомлений
- **Сегодня** — уведомления за текущий день
- **Активные эскалации** — незакрытые эскалации
- **Правил сработало** — сработавших правил за период
- **Успешная доставка** — процент успешной доставки
- **Ср. время реакции** — среднее время до прочтения
- **Активных каналов** — работающих каналов доставки
- **AI-триаж** — процент уведомлений с AI-оценкой

## Лучшие практики

1. **Настройте правила** для автоматизации рутинных уведомлений
2. **Используйте эскалации** для критичных задач
3. **Настройте дайджесты** для низкоприоритетных уведомлений
4. **Проверяйте каналы** — убедитесь в работоспособности
5. **Анализируйте метрики** — выявляйте узкие места
6. **Используйте AI-сортировку** для приоритизации

## Устранение неполадок

### Уведомление не доставлено

1. Проверьте статус канала в разделе «Каналы»
2. Проверьте настройки пользователя
3. Проверьте тихие часы
4. Просмотрите логи доставки

### Правило не срабатывает

1. Проверьте статус правила (active)
2. Проверьте условия срабатывания
3. Проверьте cooldown и лимиты
4. Просмотрите историю срабатываний

### Эскалация не происходит

1. Проверьте настройки эскалации в правиле
2. Проверьте доступность получателя
3. Проверьте, не была ли уже подтверждена
