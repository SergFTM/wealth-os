# Сверка депозитария (Custodian Reconciliation)

## Что такое сверка

Модуль синхронизирует и сверяет позиции, транзакции и денежные движения из различных источников данных — депозитариев, банков и консультантов. Цель — выявить расхождения (breaks), устранить ошибки маппинга, управлять качеством данных и формировать доказательную базу (audit-ready).

## Зачем нужна сверка

- **IBOR vs ABOR** — контроль между инвестиционной и бухгалтерской книгой
- **Качество данных** — выявление ошибок в источниках
- **Предотвращение ошибок в отчётах** — корректные данные для клиентов
- **Audit-ready** — доказательная база для аудиторов и регуляторов

## Как работает процесс

### 1. Feed Ingest (Получение данных)

Источники данных (custodian, bank, advisor) регулярно предоставляют выписки и файлы. Система автоматически загружает и парсит данные через интеграции.

### 2. Mapping (Маппинг)

Внешние идентификаторы (символы, счета, сущности) сопоставляются с внутренними. Если маппинг отсутствует — создаётся unmapped break.

### 3. Reconciliation Run (Прогон сверки)

Запускается сверка на указанную дату (as-of). Сравниваются позиции, транзакции и денежные остатки.

### 4. Breaks Triage (Разбор расхождений)

Каждое расхождение получает:

- Тип и severity
- Назначенного owner
- Статус (open → investigating → resolved)

### 5. Resolution and Audit Evidence

Расхождение закрывается с указанием причины и прикреплением подтверждающих документов (statements).

## Типы расхождений (Breaks)

| Тип                        | Описание                                     |
| -------------------------- | -------------------------------------------- |
| **Quantity Mismatch**      | Количество позиции не совпадает              |
| **Price Mismatch**         | Цена/стоимость не совпадает                  |
| **Missing Transaction**    | Транзакция есть в источнике, но не в системе |
| **Cash Movement Mismatch** | Денежное движение не совпадает               |
| **Unmapped Symbol**        | Символ из источника не найден в маппинге     |
| **Unmapped Account**       | Счёт из источника не найден                  |
| **Unmapped Entity**        | Сущность из источника не найдена             |

## Severity (Критичность)

- **Critical** — срочно требует внимания, влияет на отчётность
- **High** — важное расхождение, требует действий в течение дня
- **Medium** — стандартное расхождение
- **Low** — минимальное влияние, может быть отложено

## Что делать с расхождениями

### Исправить маппинг

Если break типа unmapped — откройте панель Mapping и создайте связь между внешним и внутренним идентификатором.

### Запустить повторную сверку

После исправления маппинга или получения новых данных — запустите re-run для проверки.

### Создать задачу

Если расхождение требует действий от коллег — создайте task с ссылкой на break.

### Приложить statement

Прикрепите выписку custodian или bank statement как доказательство для аудита.

## Source-first и Audit-ready

Каждое действие записывается в audit trail:

- Создание/редактирование feed
- Запуск sync и recon job
- Изменение статуса break
- Создание/одобрение mapping

## RBAC и Client-safe

| Роль                | Доступ                                                    |
| ------------------- | --------------------------------------------------------- |
| **Owner/Admin/Ops** | Полный доступ: run, edit, resolve                         |
| **Compliance**      | Только чтение, экспорт отчётов                            |
| **CIO/CFO**         | Чтение breaks summary                                     |
| **Client**          | Только агрегированные показатели, без технических деталей |

## Типовые сценарии

### Найти открытые расхождения

1. Откройте Dashboard → KPI "Открытые расхождения"
2. Или: List → вкладка Breaks → фильтр Status = Open

### Сверить конкретного клиента

1. List → Jobs → фильтр по клиенту
2. Нажмите "Запустить сверку" с нужными параметрами

### Добавить новый источник данных

1. Actions Bar → "Добавить источник"
2. Укажите провайдера, тип, coverage
3. Сохраните → запустите первый sync

### Одобрить маппинг

1. List → Mappings → фильтр Status = Pending
2. Проверьте соответствие external → internal
3. Нажмите "Одобрить"

### Экспортировать отчёт сверки

1. Actions Bar → "Экспорт отчёта"
2. Выберите формат (CSV/PDF) и период
