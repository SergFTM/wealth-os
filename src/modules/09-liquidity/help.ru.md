# Ликвидность и управление денежными потоками

## Что такое модуль Liquidity в MFO

Модуль **Ликвидность и кэш** предоставляет Family Office полный операционный контроль над денежными средствами и обязательствами:

- **Cash Accounts** — все банковские счета и остатки по валютам
- **Cash Movements** — фактические и планируемые движения средств
- **Forecast** — прогноз притоков/оттоков на 30/90/180 дней
- **Obligations** — периодические и разовые обязательства (кредиты, аренда, налоги)
- **Alerts** — уведомления о рисках ликвидности

---

## Liquidity Buckets

Liquidity Buckets — это агрегированное представление денежных потоков по временным периодам:

| Bucket | Описание |
|--------|----------|
| **Today** | Доступный кэш на сегодня |
| **7 дней** | Ожидаемые притоки и оттоки за неделю |
| **30 дней** | Месячный прогноз ликвидности |
| **90 дней** | Квартальный прогноз |

Каждый bucket показывает:
- Ожидаемые притоки (inflows)
- Ожидаемые оттоки (outflows)
- Чистый результат (net)
- Статус (OK / Warning / Critical)

---

## Источники данных

### Bank Feed
Автоматическая синхронизация с банками через подключения (Plaid, Yodlee, API банка).

### General Ledger (GL)
Проведенные транзакции из модуля GL используются для сверки остатков.

### Bill Pay
Запланированные платежи из модуля Bill Pay попадают в forecast как outflows.

### Private Capital
Capital calls и distributions из фондов PE/VC автоматически попадают в forecast.

---

## Прогноз (Forecast)

Forecast строится на основе:
1. **Scheduled obligations** — регулярные платежи (аренда, кредиты)
2. **Capital calls** — обязательства по PE/VC фондам
3. **Distributions** — ожидаемые распределения
4. **Dividends/Coupons** — доходы от портфеля
5. **Manual entries** — ручные прогнозы

### Confidence (уверенность в прогнозе)
- **High** — подтвержденные платежи или полученные уведомления
- **Medium** — регулярные платежи без изменений
- **Low** — оценочные прогнозы

---

## Типовые сценарии использования

### "Хватит ли кэша на 30 дней?"
1. Откройте Dashboard → посмотрите KPI "Нетто 30д"
2. Если отрицательное — откройте Buckets и проанализируйте outflows
3. При необходимости создайте задачу на перевод средств

### "Какие крупные платежи впереди?"
1. Перейдите в List → вкладка Obligations
2. Отфильтруйте по периоду (30/90 дней)
3. Отсортируйте по сумме

### "Какие счета требуют пополнения?"
1. В Dashboard смотрите KPI "Ниже порога"
2. Клик → список счетов ниже threshold
3. Создайте planned transfer или задачу

### "Почему прогноз ухудшился?"
1. Откройте Forecast Panel
2. Нажмите "Объяснить прогноз" → AI покажет изменения
3. Проверьте source references

### "Создать задачу на перенос платежа"
1. Откройте detail обязательства
2. Нажмите "Перенести"
3. Укажите новую дату → создастся задача на согласование

---

## Source-First и Audit-Ready

### Source-First подход
Каждая запись хранит:
- `sourceType` — тип источника (bank_feed, gl, billpay, manual)
- `sourceRef` — ссылка на исходную запись

### Audit Trail
Все действия логируются:
- Создание/изменение счетов
- Отметка платежей как оплаченных
- Изменение прогнозов
- Ack/Resolve алертов

---

## RBAC и Client-Safe

### Полный доступ (Owner/Admin/CFO/Ops)
- CRUD всех объектов
- Mark paid, reschedule
- Изменение thresholds
- Экспорт

### CIO
- Только чтение
- Создание report sections

### Compliance
- Только чтение
- Audit trail доступ
- Экспорт

### Client-Safe режим
- Агрегированная ликвидность
- Скрыты: bank feed details, thresholds, internal notes
- Запрещено: mark paid, reschedule

---

## Stress Test (MVP)

Простые сценарии для оценки влияния на ликвидность:
- **20% outflow shock** — увеличение всех оттоков на 20%
- **Capital call acceleration** — все calls на 2 недели раньше

Результат показывает impact на buckets и рекомендации.

---

## Связи с другими модулями

| Модуль | Связь |
|--------|-------|
| **Bill Pay** | Scheduled payments → forecast outflows |
| **Private Capital** | Capital calls/distributions → forecast |
| **General Ledger** | Posted transactions → movements verification |
| **Net Worth** | Liquid holdings → total cash |
| **Reporting** | Liquidity report sections |
| **Workflow** | Tasks для reschedule, review |

---

## FAQ

**Q: Как часто обновляются остатки?**
A: Bank feed — ежедневно. Manual — при изменении. GL — при проводке.

**Q: Что делать при критическом алерте?**
A: Откройте алерт → проанализируйте причину → создайте задачу или подтвердите.

**Q: Можно ли добавить прогноз вручную?**
A: Да, через "Добавить прогноз" в Actions Bar.
